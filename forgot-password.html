<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediVolt - Forgot Password</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="card-header">
                <div class="logo">
                    <img src="logo.jpeg" alt="MediVolt Logo" style="width: 80px; height: 80px; object-fit: contain;">
                </div>
                <h1>MediVolt</h1>
                <p>Reset Your Password</p>
            </div>
            
            <!-- Step 1: Email & Phone Verification -->
            <form id="forgotForm">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" placeholder="admin@hospital.com" required>
                </div>
                
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" placeholder="+1 (555) 123-4567" required>
                </div>
                
                <button type="submit" id="sendOtpBtn">Send OTP</button>
            </form>
            
            <!-- Step 2: OTP Verification (Hidden by default) -->
            <form id="otpForm" style="display: none;">
                <div class="otp-message">
                    <p>Enter the 6-digit OTP sent to your email</p>
                </div>
                
                <div class="form-group">
                    <label for="otp">OTP Code</label>
                    <input type="text" id="otp" placeholder="Enter 6-digit OTP" maxlength="6" required>
                </div>
                
                <button type="submit" id="verifyOtpBtn">Verify OTP</button>
                
                <div class="resend-otp">
                    <p>Didn't receive OTP? <a href="#" id="resendLink">Resend</a></p>
                </div>
            </form>
            
            <!-- Step 3: New Password (Hidden by default) -->
            <form id="resetForm" style="display: none;">
                <div class="success-message">
                    <p>OTP Verified Successfully!</p>
                </div>
                
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" placeholder="Enter new password" required>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm new password" required>
                </div>
                
                <button type="submit" id="resetPasswordBtn">Reset Password</button>
            </form>
            
            <!-- Success Message -->
            <div id="successSection" style="display: none;" class="success-section">
                <div class="success-icon">✓</div>
                <h3>Password Reset Successful!</h3>
                <p>Your password has been updated. Redirecting to login...</p>
                <a href="login.html" class="login-link">Go to Login</a>
            </div>
            
            <div class="card-footer">
                <a href="login.html" class="back-link">← Back to Login</a>
            </div>
        </div>
    </div>
    
    <script src="script.js"></script>
    <script>
        // Forgot Password JavaScript - Connected to Python API
        document.addEventListener('DOMContentLoaded', function() {
            const forgotForm = document.getElementById('forgotForm');
            const otpForm = document.getElementById('otpForm');
            const resetForm = document.getElementById('resetForm');
            const successSection = document.getElementById('successSection');
            const resendLink = document.getElementById('resendLink');
            
            let userEmail = '';
            let generatedOTP = '';
            
            // API Base URL - Dynamic for local and production
            const API_BASE = window.location.origin + '/api';
            
            // Generate random 6-digit OTP (fallback)
            function generateOTP() {
                return Math.floor(100000 + Math.random() * 900000).toString();
            }
            
            // Send OTP to API
            if (forgotForm) {
                forgotForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const email = document.getElementById('email').value;
                    const phone = document.getElementById('phone').value;
                    
                    if (email && phone) {
                        userEmail = email;
                        const sendOtpBtn = document.getElementById('sendOtpBtn');
                        sendOtpBtn.textContent = 'Sending...';
                        sendOtpBtn.disabled = true;
                        
                        try {
                            const response = await fetch(`${API_BASE}/send-otp`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ email, phone })
                            });
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                // Store OTP for verification (or use demo_otp in development)
                                generatedOTP = data.demo_otp || data.otp;
                                console.log('OTP received:', generatedOTP);
                                
                                alert('OTP sent to ' + email + '! (Demo OTP: ' + generatedOTP + ')');
                                
                                // Hide email form, show OTP form
                                forgotForm.style.display = 'none';
                                otpForm.style.display = 'block';
                            } else {
                                alert('Error: ' + data.message);
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            // Fallback to demo mode if API is not running
                            generatedOTP = generateOTP();
                            alert('API not connected. Using demo mode. OTP: ' + generatedOTP);
                            forgotForm.style.display = 'none';
                            otpForm.style.display = 'block';
                        }
                        
                        sendOtpBtn.textContent = 'Send OTP';
                        sendOtpBtn.disabled = false;
                    }
                });
            }
            
            // Verify OTP via API
            if (otpForm) {
                otpForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const enteredOTP = document.getElementById('otp').value;
                    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
                    
                    try {
                        verifyOtpBtn.textContent = 'Verifying...';
                        verifyOtpBtn.disabled = true;
                        
                        const response = await fetch(`${API_BASE}/verify-otp`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ email: userEmail, otp: enteredOTP })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            // OTP verified
                            otpForm.style.display = 'none';
                            resetForm.style.display = 'block';
                        } else {
                            alert('Invalid OTP! Please try again.');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        // Fallback to demo mode
                        if (enteredOTP === generatedOTP) {
                            otpForm.style.display = 'none';
                            resetForm.style.display = 'block';
                        } else {
                            alert('Invalid OTP! Please try again.');
                        }
                    }
                    
                    verifyOtpBtn.textContent = 'Verify OTP';
                    verifyOtpBtn.disabled = false;
                });
                
                // Resend OTP
                if (resendLink) {
                    resendLink.addEventListener('click', async function(e) {
                        e.preventDefault();
                        
                        try {
                            const response = await fetch(`${API_BASE}/send-otp`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ 
                                    email: userEmail, 
                                    phone: document.getElementById('phone').value 
                                })
                            });
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                generatedOTP = data.demo_otp;
                                alert('New OTP sent! (Demo: ' + generatedOTP + ')');
                            }
                        } catch (error) {
                            generatedOTP = generateOTP();
                            alert('API not connected. New OTP: ' + generatedOTP);
                        }
                    });
                }
            }
            
            // Reset Password via API
            if (resetForm) {
                resetForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    if (newPassword === confirmPassword && newPassword.length >= 6) {
                        const resetPasswordBtn = document.getElementById('resetPasswordBtn');
                        resetPasswordBtn.textContent = 'Resetting...';
                        resetPasswordBtn.disabled = true;
                        
                        try {
                            const response = await fetch(`${API_BASE}/reset-password`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ email: userEmail, newPassword })
                            });
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                resetForm.style.display = 'none';
                                successSection.style.display = 'block';
                                
                                // Redirect after 3 seconds
                                setTimeout(function() {
                                    window.location.href = 'login.html';
                                }, 3000);
                            } else {
                                alert('Error: ' + data.message);
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            // Demo mode - just show success
                            resetForm.style.display = 'none';
                            successSection.style.display = 'block';
                            
                            setTimeout(function() {
                                window.location.href = 'login.html';
                            }, 3000);
                        }
                        
                        resetPasswordBtn.textContent = 'Reset Password';
                        resetPasswordBtn.disabled = false;
                    } else if (newPassword.length < 6) {
                        alert('Password must be at least 6 characters!');
                    } else {
                        alert('Passwords do not match!');
                    }
                });
            }
        });
    </script>
</body>
</html>
